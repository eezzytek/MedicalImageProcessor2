Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  config.vm.provider "qemu" do |qe|
    qe.arch = "aarch64"
    qe.ssh_port = 2225  # ФІКС: Новий host SSH port (2224, щоб уникнути конфлікту)
    qe.memory = "2048"
    qe.cpus = 2
    qe.net_device = "virtio-net-pci"
    qe.extra_args = ["-machine", "virt,accel=hvf"]
  end

  config.vm.provision "shell", inline: <<-SHELL
    # Онови систему
    apt-get update -y
    apt-get upgrade -y

    # Встанови Docker
    apt-get install -y docker.io
    systemctl start docker
    systemctl enable docker
    usermod -aG docker vagrant

    # Запусти BaGet з ARM64
    docker run -d --platform linux/arm64 --name baget -p 5000:80 loicsharma/baget

    # Чекаємо старту
    sleep 30

    # Дебаг
    docker logs baget
    docker ps | grep baget

    # Конфігурація (якщо running)
    if [ "$(docker inspect -f '{{.State.Status}}' baget)" = "running" ]; then
      docker exec baget dotnet baget.dll --apiKey "my-secret-key" --storage /var/www/data
    else
      echo "BaGet not running!"
      exit 1
    fi

    # Побудуй .nupkg
    cd /vagrant
    dotnet pack MedicalImageProcessor.Infrastructure/MedicalImageProcessor.Infrastructure.csproj -c Debug -o ./temp_nupkg

    # Push
    curl -X PUT -u "my-secret-key:" "http://localhost:5000/v3/index.json" --data-binary "@./temp_nupkg/MedicalImageProcessor.Infrastructure.1.0.0.nupkg" -H "Content-Type: application/octet-stream"

    # Тест
    curl "http://localhost:5000/v3/index.json"

    # IP VM для доступу
    IP=$(hostname -I | awk '{print $2}')
    echo "BaGet: http://$IP:5000 (ssh vagrant@127.0.0.1 -p 2225)"
  SHELL

  # ФІКС: Видаляємо forwarded_port (QEMU ігнорує, викликає collision)
  # config.vm.network "forwarded_port", guest: 5000, host: 5001  # Коментуємо

end